<html>
  <head>
    <title>p1</title>
    <link rel="stylesheet" type="text/css" href="styles/styles.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <body>
    <div id='wrapper'>
      <br>
      <h1>Title</h1>
      <script>
        function entityRow(d) {
          return {
            entity_id: d.entity_id,
            name: d.entity_name,
            category: d.category
          };
        }
        function tweetRow(d, array) {
          array.push({
            tweet_id: d.tweet_id,
            polarity: d.polarity
          });
        }
        function timeRow(d, array) {
          array.push({
            tweet_id: d.tweet_id,
            unixTime: d.timestamp,
            time: Date(d.timestamp*1000)
          });
        }
        function searchByTweetId(id, array) {
          for (var i= 0; i< array.length; i++) {
            if (array[i].tweet_id == id) {
              return array[i];
            }
          }
        }
        function mergeTweets(polarity, times, d) {
          var tweets = [];
          for (var j=0; j<polarity.length; j++) {
            var match = searchByTweetId(polarity[j].tweet_id, times);
            var newTweet = { tweet_id:polarity[j].tweet_id,
                             polarity:polarity[j].polarity,
                             unixTime:match.unixTime,
                             time:match.time }
            tweets.push(newTweet);
            d['tweets'] = tweets;
          }
        }

        var wrapper = document.getElementById("wrapper");
        var svg = d3.select(wrapper).append("svg");
        svg.attr("width","100%").attr("height",750);

        var svgWidth = document.getElementsByTagName("svg")[0].offsetWidth;

        //var minTime = 1249351893;
        var minTime = new Date(1300000000*1000);
        var maxTime = new Date(1348581639*1000);
        var xScale = d3.scaleTime().domain([minTime,maxTime]).range([3,svgWidth-3]);
        var xAxis = d3.axisBottom(xScale);
        var plotXAxis = svg.append("g")
          .attr("transform", "translate(0,100)")
          .call(xAxis);

        d3.tsv("replab2013_entities.tsv", entityRow, function(error, data) {
          entity_data = data;
          entity_data.forEach(function(d) {
            var polarity = [];
            var times = [];

            d3.queue()
              .defer(d3.tsv, "labeled/"+d.entity_id+".tsv", function(data) { tweetRow(data, polarity); })
              .defer(d3.tsv, "tweet_info/"+d.entity_id+".tsv", function(data) { timeRow(data, times); })
              .await(function() {
                mergeTweets(polarity, times, d);
                for (var i=0; i<d.tweets.length; i++) {
                  var t = d.tweets[i];
                  if (t.polarity == "POSITIVE") { var cy = 15; }
                  if (t.polarity == "NEGATIVE") { var cy = 45; }
                  if (t.polarity == "NEUTRAL" || t.polarity == "") { var cy = 30; }

                  if (d.category == "automotive") { var fillColor = "red"; }
                  if (d.category == "banking") { var fillColor = "green"; }
                  if (d.category == "music") { var fillColor = "blue"; }
                  if (d.category == "university") { var fillColor = "black"; }

                  svg.append("circle").attr("r",3)
                                      .attr("cx",xScale(t.unixTime*1000))
                                      .attr("cy",cy)
                                      .attr("fill", fillColor)
                                      .attr("opacity", .2);
                }
               });
          });
        });
      </script>
    </div>
  </body>
</html>

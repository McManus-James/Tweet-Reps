<html>
  <head>
    <title>p1</title>
    <link rel="stylesheet" type="text/css" href="styles/styles.css">
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <body>
    <div id='wrapper'>
      <br>
      <script>
        function entityRow(d) {
          return {
            entity_id: d.entity_id,
            name: d.entity_name,
            category: d.category
          };
        }
        function tweetRow(d, array) {
          array.push({
            tweet_id: d.tweet_id,
            polarity: d.polarity
          });
        }
        function timeRow(d, array) {
          array.push({
            tweet_id: d.tweet_id,
            unixTime: d.timestamp,
            time: new Date(d.timestamp*1000)
          });
        }
        function searchByTweetId(id, array) {
          for (var i= 0; i< array.length; i++) {
            if (array[i].tweet_id == id) {
              return array[i];
            }
          }
        }
        function mergeTweets(polarity, times, d) {
          var tweets = [];
          for (var j=0; j<polarity.length; j++) {
            var match = searchByTweetId(polarity[j].tweet_id, times);
            var newTweet = { tweet_id:polarity[j].tweet_id,
                             polarity:polarity[j].polarity,
                             unixTime:match.unixTime,
                             time:match.time }
            tweets.push(newTweet);
            d['tweets'] = tweets;
          }
        }

        var wrapper = document.getElementById("wrapper");

        d3.tsv("replab2013_entities.tsv", entityRow, function(error, data) {
          // Set up plot
          var xAxisDisplacement = 35;
          var yAxisDisplacement = 5;
          var yHeight = 450;

          //var minTime = 1249351893;
          var minTime = new Date(1338163200*1000);
          var maxTime = new Date(1348581639*1000);
          var rangeTime = (1348581639-1333238400)/60/60/24;

          function makeScales(t) {
            var title = d3.select(wrapper).append("h1")
                                          .attr("x",0)
                                          .attr("y",10)
                                          .text(t);
            var svg = d3.select(wrapper).append("svg");
            svg.attr("width","100%")
               .attr("height",500);
            var svgWidth = document.getElementsByTagName("svg")[0].offsetWidth;

            // Set scales
            var xScale = d3.scaleTime().domain([minTime,maxTime]).range([xAxisDisplacement,(svgWidth-xAxisDisplacement)]);
            var xAxis = d3.axisBottom(xScale);
            var plotXAxis = svg.append("g")
              .attr("transform", "translate(0,"+(yHeight+yAxisDisplacement)+")")
              .call(xAxis);
            var yScale = d3.scaleLog().domain([1,1000]).range([1,yHeight]);
            var yAxis = d3.axisLeft(yScale);
            var plotYAxis = svg.append("g")
              .attr("transform", "translate("+xAxisDisplacement+","+yAxisDisplacement+")")
              .call(yAxis);
            return [xScale,yScale,svg];
          }

          function showGraph(d, xScale, yScale, svg) {
            var svgWidth = document.getElementsByTagName("svg")[0].offsetWidth;
            // Parse data
            var polarity = [];
            var times = [];

            d3.queue()
              .defer(d3.tsv, "labeled/"+d.entity_id+".tsv", function(data) { tweetRow(data, polarity); })
              .defer(d3.tsv, "tweet_info/"+d.entity_id+".tsv", function(data) { timeRow(data, times); })
              .await(function() {
                mergeTweets(polarity, times, d);
                y = [];
                for (var i=0; i<d.tweets.length; i++) {
                  var t = d.tweets[i];

                  // Convert polarity
                  if (t.polarity == "POSITIVE") { var pol = 1; }
                  if (t.polarity == "NEGATIVE") { var pol = -1; }
                  if (t.polarity == "NEUTRAL" || t.polarity == "") { var pol = 0; }

                  // Convert data to y-axis
                  var fullDate = new Date(t.time);
                  var day = fullDate.getDate();
                  if (String(day).length< 2) { day = "0"+day; }
                  var month = fullDate.getMonth()+1;
                  if (String(month).length< 2) { month = "0"+month; }
                  var year = fullDate.getFullYear();
                  var date = year+"-"+month+"-"+day;

                  // Check for duplicate dates and iterate over existing values if found
                  if (y.length == 0) { y.push({ date:date, count:1, polarity:pol }); }
                  for (u in y) {
                    if (y[u].date == date) {
                      y[u].count++;
                      y[u].polarity+= pol;
                      break;
                    }
                    if (u == y.length-1) {
                      y.push({ date:date, count:1, polarity:pol });
                    }
                  }
                }
                for (j in y) {
                  y[j].polarity = y[j].polarity/y[j].count;
                  if (typeof y[j] != 'undefined') {
                    if (d.category == "automotive") { var fillColor = "gold"; }
                    if (d.category == "banking") { var fillColor = "lightseagreen"; }
                    if (d.category == "music") { var fillColor = "purple"; }
                    if (d.category == "university") { var fillColor = "blue"; }
                    if (y[j].polarity < 0) { var fillColor = "red"; }

                    svg.append("rect").attr("x", xScale(new Date(y[j].date))+xAxisDisplacement)
                                      .attr("y", yAxisDisplacement)
                                      .attr("height", yScale(y[j].count))
                                      .attr("width", svgWidth/rangeTime)
                                      .attr("fill", fillColor)
                                      .attr("opacity", Math.abs(y[j].polarity));
                  }
                }
              });
          }

          // Display data
          entity_data = data;
          var scales = makeScales("All Companies");
          var counter = 0;
          entity_data.forEach(function(d) {
            if (counter%2 == 0) { // arbitrary data limitation
              showGraph(d, scales[0], scales[1], scales[2]);
            }
            counter++;
          });
          var scales = makeScales(entity_data[26].name);
          showGraph(entity_data[26], scales[0], scales[1], scales[2]);
        });


      </script>
    </div>
  </body>
</html>
